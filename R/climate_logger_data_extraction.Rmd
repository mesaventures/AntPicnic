---
title: "Extraction of climate logger data"
author: "Nelma Peclard"
date: "2024-11-15"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)

#empty environment before starting the script
rm(list=ls()) 

# Load necessary libraries
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(RColorBrewer)
library(hms)
```

#### 1. Filtering the relevant climate logger files

My first step is to extract all file names from the climate logger data files so that I can keep only the climate loggers which were used in ant picnic experiments and see if there are climate loggers for which I do not have data files.

```{r 1.1 extract filenames}
# Specify the directory containing the climate logger CSV files
directory <- "../data/climate_loggers/calibrated_data"

# Get all CSV filenames
file_list <- list.files(path = directory, pattern = "\\.csv$", full.names = FALSE)

# Convert to a data frame
file_df <- data.frame(File_Name = file_list)

# Save the list of filenames to a CSV file
write.csv(file_df, "../data/climate_loggers/climate_logger_filenames_all_years.csv", row.names = FALSE)
```

Then I use the created filenames file and match it with the list of climate logger IDs used in the 2022-2023 experiments.

```{r 1.2 matching logger IDs}

# Load the list of filenames
file_df <- read.csv("../data/climate_loggers/climate_logger_filenames_all_years.csv")

# Load the desired serial numbers
needed_loggers <- read.csv("../data/climate_loggers/climate_logger_ids_all_years.csv")

#remove duplicates and missing values so climate logger appears only once, and keeping only the climate logger ID column
needed_loggers_unique <- as.data.frame(unique(needed_loggers[!is.na(needed_loggers$Climate_logger_ID),2]))
colnames(needed_loggers_unique) <- c("Climate_logger_ID")
needed_loggers_unique$Climate_logger_ID <- as.character(needed_loggers_unique$Climate_logger_ID)
# checking if the number of unique logger ID matches 
nrow(needed_loggers_unique) == length(levels(as.factor(needed_loggers$Climate_logger_ID)))

# Extract serial numbers from filenames (e.g., "Logger12345.csv" -> "12345")
file_df <- file_df %>%
  mutate(Climate_logger_ID = str_extract(File_Name, "\\d+"))  # Extract numeric serial number

# Filter filenames based on desired serial numbers
filtered_files <- file_df %>%
  filter(Climate_logger_ID %in% needed_loggers_unique$Climate_logger_ID)

# Save the filtered list to a new CSV file
write.csv(filtered_files, "../data/climate_loggers/filtered_climate_loggers.csv", row.names = FALSE)

# Perform an anti-join to find missing loggers
missing_loggers <- needed_loggers_unique %>%
  anti_join(file_df, by = "Climate_logger_ID")
nrow(missing_loggers)

# Save the missing loggers to a new CSV file
write.csv(missing_loggers, "../data/climate_loggers/missing_climate_loggers.csv", row.names = FALSE)

```

Then, I remove all climate logger files which do not match the climate logger IDs used in the ant picnic.

```{r 1.3 removing unmatched files}

# Load the filtered list of files to keep
filtered_filenames <- filtered_files$File_Name

# Get the list of all files in the folder
all_filenames <- list.files(path = directory, pattern = "\\.csv$", full.names = TRUE)

# Identify files to delete (those not in the filtered list)
files_to_delete <- all_filenames[!basename(all_filenames) %in% filtered_filenames]

#double-checking the files to be deleted are not in the filtered files
files_to_delete[(files_to_delete %in% filtered_files$File_Name)]

# Delete the unwanted files
file.remove(files_to_delete)

# Output the result
cat("Deleted", length(files_to_delete), "files.")

```

I rename all the files so that the climate logger ID is the first word of the file name (i.e., remove the "data_" prefix).

```{r 1.4 renaming logger files}

# List all CSV files in the directory
files_to_rename <- list.files(path = directory, pattern = "\\.csv$", full.names = TRUE)

# Loop through each file and rename
for (file in files_to_rename) {
  # Extract the base filename
  base_name <- basename(file)
  
  # Remove the prefixes "conv_data_"
  new_name <- str_remove(base_name, "conv_data_")
  
  # Full path for the new file
  new_file_path <- file.path(directory, new_name)
  
  # Rename the file
  file.rename(file, new_file_path)
}
```


After this step, I manually went through all the .csv files and checked all cases where 2 files had the same logger ID. If the information was the same (same date range, number of rows), I deleted one copy to only have 1 file for each logger. If the information was different, i.e. the date ranges were not the same (e.g. 1st file ended in June 2022 and 2nd file went from April 2023 to September 2023), I kept the two files since the information was not redundant.

#### 2. Cleaning up climate logger data

I want to add headers to all climate logger files, and remove the columns which are not relevant to me. According to the Tomst (climate logger manufacturer) website, the columns contain the following information:

  1) Count column, increases by one with each measurement
  
  2) Date and Time, given in UTC
  
  3) Time zone parameter, indicates how many quarter-hours to add to UTC
  
  4-6) Temperature measures 1, 2 and 3 (-6, +2, +15 cm above ground)
  
  7) Soil moisture, raw soil moisture value, needs to be converted into volumetric soil moisture.
  
  8) Calibrated volumetric soil moisture value in (ratio of volume of water to unit volume of soil, in %).
  
  9)Shake, default value which is not relevant for data analysis.
  
  10) errFlag, should be equal to 0.
  
 
For each climate logger data file, I will first check that all values for the errFlag column are equal to 0. Then, I will remove the irrelevant columns and add column names for the remaining columns. I will also add a column which contains the climate logger ID number. This cleaned table will be saved into a .csv file in a new "cleaned_logger_data" folder.

```{r 2.1 cleaning logger data}
#empty environment before starting a new section
rm(list=ls()) 

# Define folder paths
input_folder <- "../data/climate_loggers/calibrated_data"
output_folder <- "../data/climate_loggers/cleaned_logger_data"

# List all .csv files in the folder
file_list <- list.files(path = input_folder, pattern = "\\.csv$", full.names = TRUE)

# Loop through each file
for (file in file_list) {
  # Extract logger ID from the file name
  file_name <- basename(file)
  logger_id <- strsplit(file_name, "_")[[1]][1] # First part of the file name
  
  # Read the data
  data <- read.csv(file, sep = ";", dec = ",", header = FALSE)
  
  # Check that `errFlag` column (column 10) only contains zeros
  if (!all(is.na(data[, 10]))) {
    warning(paste("Non-zero values found in errFlag for file:", file))
    next # Skip this file
  }
  
  # Select relevant columns
  data <- data[, c(2, 4:8)]
  
  # Add the logger ID as a new column
  logger_id_column <- rep(logger_id, nrow(data))
  
  # Use cbind to add the logger ID as the first column
  data <- cbind(Logger_ID = logger_id_column, data)
  
  # Rename the columns
  column_headers <- c("Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture")
  colnames(data) <- column_headers
  
  # replace the "," decimal point in the Vol_soil_moisture column and make it a numerical vector
  data$Vol_soil_moisture <- as.numeric(gsub(",", ".", data$Vol_soil_moisture))
  
  # Save the cleaned data
  output_file <- file.path(output_folder, paste0("clean_", file_name))
  write.csv(data, output_file, row.names = FALSE)
}

# all files had no errors flagged and were cleaned successfully.
```

Now that all the data has been reduced to the relevant columns and that my columns have names, I need to adjust the time column. The TMS-4 climate logger records measurements in UTC time. However, my experiments were done in Germany between April and July, which is in Central European Summer Time, or UTC+2. This means that I need to adjust my time measurements by adding two hours to every measurement, to account for the time zone factor.

```{r 2.2 adjust data for time zone}
# Define folder paths
input_folder <- "../data/climate_loggers/cleaned_logger_data"
output_folder <- "../data/climate_loggers/german_time_data"

# List all cleaned .csv files in the folder
file_list <- list.files(path = input_folder, pattern = "\\.csv$", full.names = TRUE)

# Create empty vector to store filenames with issues
files_with_issues <- c()

# Loop through each file
for (file in file_list) {
  
  # Read the cleaned data file
  data <- read.csv(file, header = TRUE)
  
  # Attempt to convert the 'Date_time' column to a POSIXct object (in UTC)
  conversion_result <- tryCatch({
    # Using ymd_hm() to parse the date-time
    data$Date_time <- ymd_hm(data$Date_time)
    NULL  # No error, return NULL to indicate success
  }, warning = function(w) {
    # If a warning occurs, return the warning message
    return(paste("Warning:", w$message))
  }, error = function(e) {
    # If an error occurs, return the error message
    return(paste("Error:", e$message))
  })
  
  # If the conversion result is not NULL, it means an error or warning occurred
  if (!is.null(conversion_result)) {
    # Add the problematic file to the list
    files_with_issues <- c(files_with_issues, basename(file))
    print(paste("Problem with file:", basename(file), ":", conversion_result))
    next  # Skip this file and move to the next one
  }
  
  # If no issues, adjust the time zone (UTC to CEST)
  data$Date_time <- data$Date_time + hours(2)
  
  # Generate the output file name by replacing "clean_" with "cest_"
  output_file_name <- sub("^clean_", "cest_", basename(file))
  # Create the full path for the output file
  output_file <- file.path(output_folder, output_file_name)
  # Save the adjusted data to the new file
  write.csv(data, output_file, row.names = FALSE)
  
  print(paste("Time adjusted for file:", basename(file)))
}

# After processing, print the list of files with issues
if (length(files_with_issues) > 0) {
  cat("The following files encountered issues during Date_time conversion:\n")
  print(files_with_issues)
} else {
  cat("All files were processed successfully.\n")
}

## All files had the same date_time format (ymd_hm),  and were thus processed successfully.
```


#### 3. Extracting climate logger data from experiment times

Now that I have the cleaned logger files which have been converted to UTC + 2 and only contain the relevant columns, I will extract the climate data collected during the time of all Ant Picnic experiments.

The first step is to compile a data frame for each year with the Sample ID, the climate logger ID, the starting time of the experiment in a date-time format, as well as the experiment day and start/end times as strings.

```{r 3.1 preparing experiment date_time data}
# clean environment since these steps are unrelated to the previous steps
rm(list=ls()) 

### 2022 data
# load 2022 data
times_2022 <- read.csv("../data/location_data_for_logger_extraction/Ant Picnic Data - 2022 location data.csv", header = T)
# keep only relevant columns
times_2022 <- times_2022[,c(1, 3:6)]

# create Date_time column which merges the date and start time
date_time_2022 <- paste0(times_2022$Date, sep = " ", times_2022$Start_time)
# add date_time column to times_2022 data frame and reorganize columns
times_2022 <- cbind(times_2022[,1], times_2022[,5], date_time_2022, times_2022[,2:4])
colnames(times_2022) <- c("Sample_ID", "Climate_logger_ID",	"Date_time", "Date",	"Start_time",	"End_time")

# Use dmy_hms() to parse the date-time
times_2022$Date_time <- dmy_hm(times_2022$Date_time) # 4 rows were not converted because either the date, the start time or both were missing


### 2023 data
# load 2023 data
times_2023 <- read.csv("../data/location_data_for_logger_extraction/Ant Picnic Data - 2023 location data.csv", header = T)
# keep only relevant columns
times_2023 <- times_2023[,c(1, 3:6)]

# create Date_time column which merges the date and start time
date_time_2023 <- paste0(times_2023$Date, sep = " ", times_2023$Start_time)
# add date_time column to times_2023 data frame and reorganize columns
times_2023 <- cbind(times_2023[,1], times_2023[,5], date_time_2023, times_2023[,2:4])
colnames(times_2023) <- c("Sample_ID", "Climate_logger_ID",	"Date_time", "Date",	"Start_time",	"End_time")

# Use dmy_hms() to parse the date-time
times_2023$Date_time <- dmy_hm(times_2023$Date_time) # 1 row was not converted because the start time was missing


### 2024 data
# load 2024 data
times_2024 <- read.csv("../data/location_data_for_logger_extraction/Ant Picnic Data - 2024 location data.csv", header = T)
# keep only relevant columns
times_2024 <- times_2024[,c(1, 3:6)]

# create Date_time column which merges the date and start time
date_time_2024 <- paste0(times_2024$Date, sep = " ", times_2024$Start_time)
# add date_time column to times_2024 data frame and reorganize columns
times_2024 <- cbind(times_2024[,1], times_2024[,5], date_time_2024, times_2024[,2:4])
colnames(times_2024) <- c("Sample_ID", "Climate_logger_ID",	"Date_time", "Date",	"Start_time",	"End_time")

# Use dmy_hms() to parse the date-time
times_2024$Date_time <- dmy_hm(times_2024$Date_time)


### merging all yearly tables
times_all <- rbind(times_2022, times_2023, times_2024)
# Use dmy() to make the Date column a POSIXct object
times_all$Date <- dmy(times_all$Date)
```

Then, all climate logger files will be merged into 1 huge file, which will then be filtered and reduced to only contain data from days where an experiment was conducted.

```{r 3.2 merging climate data}
# Define folder paths
input_folder <- "../data/climate_loggers/german_time_data"

# List all .csv files in the folder
file_list <- list.files(path = input_folder, pattern = "\\.csv$", full.names = TRUE)

# Initialize an empty list to store data frames
merged_data_list <- list()

# Loop through each file and read the data
for (file in file_list) {
  # Read the data from the file
  data <- read.csv(file, header = TRUE)

  # Append the data to the list
  merged_data_list <- append(merged_data_list, list(data))
}

# Combine all data frames into one large data frame using bind_rows from dplyr
merged_data <- bind_rows(merged_data_list)

# Check the first few rows of the merged data
head(merged_data)

# save the merged data frame as a CSV
write.csv(merged_data, "../data/climate_loggers/merged_climate_data.csv", row.names = FALSE)

### Keeping data only from experiment days

# keeping only rows from days where experiments where conducted

# if the chunk above was not run:
# merged_data <- read.csv("../data/climate_loggers/merged_climate_data.csv", header = T)

# Filter merged_climate_data to keep only rows with dates that match experiment dates
climate_data_exp_days <- merged_data %>%
  filter(as.Date(Date_time) %in% times_all$Date)

# Extract unique dates from the Date_time column in climate_data_exp_days
unique_climate_dates <- unique(as.Date(climate_data_exp_days$Date_time))
# Compare with the experiment dates in times_2022
experiment_dates <- unique(times_all$Date)

length(unique_climate_dates)
length(experiment_dates)

# check dates that were excluded
excluded_dates <- setdiff(experiment_dates, unique_climate_dates)
print(excluded_dates) # only 1 missing value was excluded, all experiment dates should be in the climate_exp_days file.

# save the filtered data to a new file
write.csv(climate_data_exp_days, "../data/climate_loggers/climate_data_exp_days.csv", row.names = FALSE)
```

Once we have the experiment start times for each year and the combined climate logger data file, I can extract the measures taken during each experiment. This is done by finding the measurement taken by the corresponding climate logger which was taken closest to the starting time of the experiment, and extracting it along with the 8 following measurements to cover the span of the 120-minute experiment. This process is repeated for each year.

```{r 3.3 extracting experiment climate data for 2023}
# If needed, read climate data experiment days table
# climate_data_exp_days <- read.csv("../data/climate_loggers/climate_data_exp_days.csv", header = T)

# Ensure both Date_time columns are in POSIXct format
times_2023$Date_time <- ymd_hms(times_2023$Date_time)
climate_data_exp_days$Date_time <- ymd_hms(climate_data_exp_days$Date_time)

# Create a new data frame to store the result
experiment_climate_data <- data.frame()

# Loop through each experiment (unique Sample_ID)
for (i in unique(times_2023$Sample_ID)) {
  
  # Extract experiment row (for this specific Sample_ID)
  experiment_row <- times_2023 %>% filter(Sample_ID == i)
  
  # Extract the experiment's start time and the associated climate logger ID
  start_time <- experiment_row$Date_time
  climate_logger_id <- experiment_row$Climate_logger_ID
  
  # Check if the climate logger ID is NA
  if (is.na(climate_logger_id)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = NA,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Filter the climate data for the relevant climate logger
  logger_data <- climate_data_exp_days %>% filter(Logger_ID == climate_logger_id)
  
  # Check if logger_data is empty
  if (nrow(logger_data) == 0) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Calculate the time difference between each climate measurement and the experiment's start time
  logger_data <- logger_data %>%
    mutate(time_diff = abs(difftime(Date_time, start_time, units = "mins")))
  
  # Find the index of the closest measurement
  if (all(is.na(logger_data$time_diff))) {
    # Add a row of NAs if time differences cannot be computed
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  start_index <- which.min(logger_data$time_diff)
  
  # Check if start_index is valid
  if (length(start_index) == 0 || is.na(start_index)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Extract the next 9 measurements (starting from the closest measurement)
  end_index <- min(start_index + 8, nrow(logger_data))  # Ensure we don't exceed the number of rows
  experiment_period_data <- logger_data[start_index:end_index, ]
  
  # Add Sample_ID to the extracted data for traceability
  experiment_period_data$Sample_ID <- i
  
  # Combine the result into the main data frame
  experiment_climate_data <- bind_rows(experiment_climate_data, experiment_period_data)
}

# Check the first few rows of the result
head(experiment_climate_data)
length(unique(experiment_climate_data$Sample_ID))

# Re-order the columns to have the Sample ID first
experiment_climate_data <- cbind(experiment_climate_data[,9], experiment_climate_data[,1:8])
colnames(experiment_climate_data) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# save the result to a CSV
write.csv(experiment_climate_data, "../data/env_data_loggers/env_data_2023.csv", row.names = FALSE)
```

```{r 3.4 extracting experiment climate data for 2022}
# If needed, read climate data experiment days table
# climate_data_exp_days <- read.csv("../data/climate_loggers/climate_data_exp_days.csv", header = T)

# Ensure both Date_time columns are in POSIXct format
times_2022$Date_time <- ymd_hms(times_2022$Date_time)
climate_data_exp_days$Date_time <- ymd_hms(climate_data_exp_days$Date_time)

# Create a new data frame to store the result
experiment_climate_data <- data.frame()

# Loop through each experiment (unique Sample_ID)
for (i in unique(times_2022$Sample_ID)) {
  
  # Extract experiment row (for this specific Sample_ID)
  experiment_row <- times_2022 %>% filter(Sample_ID == i)
  
  # Extract the experiment's start time and the associated climate logger ID
  start_time <- experiment_row$Date_time
  climate_logger_id <- experiment_row$Climate_logger_ID
  
  # Check if the climate logger ID is NA
  if (is.na(climate_logger_id)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = NA,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Filter the climate data for the relevant climate logger
  logger_data <- climate_data_exp_days %>% filter(Logger_ID == climate_logger_id)
  
  # Check if logger_data is empty
  if (nrow(logger_data) == 0) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Calculate the time difference between each climate measurement and the experiment's start time
  logger_data <- logger_data %>%
    mutate(time_diff = abs(difftime(Date_time, start_time, units = "mins")))
  
  # Find the index of the closest measurement
  if (all(is.na(logger_data$time_diff))) {
    # Add a row of NAs if time differences cannot be computed
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  start_index <- which.min(logger_data$time_diff)
  
  # Check if start_index is valid
  if (length(start_index) == 0 || is.na(start_index)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Extract the next 9 measurements (starting from the closest measurement)
  end_index <- min(start_index + 8, nrow(logger_data))  # Ensure we don't exceed the number of rows
  experiment_period_data <- logger_data[start_index:end_index, ]
  
  # Add Sample_ID to the extracted data for traceability
  experiment_period_data$Sample_ID <- i
  
  # Combine the result into the main data frame
  experiment_climate_data <- bind_rows(experiment_climate_data, experiment_period_data)
}

# Check the first few rows of the result
head(experiment_climate_data)
length(unique(experiment_climate_data$Sample_ID))

# Re-order the columns to have the Sample ID first
experiment_climate_data <- cbind(experiment_climate_data[,9], experiment_climate_data[,1:8])
colnames(experiment_climate_data) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# save the result to a CSV
write.csv(experiment_climate_data, "../data/env_data_loggers/env_data_2022.csv", row.names = FALSE)
```

```{r 3.5 extracting experiment climate data for 2024}
# If needed, read climate data experiment days table
# climate_data_exp_days <- read.csv("../data/climate_loggers/climate_data_exp_days.csv", header = T)

# Ensure both Date_time columns are in POSIXct format
times_2024$Date_time <- ymd_hms(times_2024$Date_time)
climate_data_exp_days$Date_time <- ymd_hms(climate_data_exp_days$Date_time)

# Create a new data frame to store the result
experiment_climate_data <- data.frame()

# Loop through each experiment (unique Sample_ID)
for (i in unique(times_2024$Sample_ID)) {
  
  # Extract experiment row (for this specific Sample_ID)
  experiment_row <- times_2024 %>% filter(Sample_ID == i)
  
  # Extract the experiment's start time and the associated climate logger ID
  start_time <- experiment_row$Date_time
  climate_logger_id <- experiment_row$Climate_logger_ID
  
  # Check if the climate logger ID is NA
  if (is.na(climate_logger_id)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = NA,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Filter the climate data for the relevant climate logger
  logger_data <- climate_data_exp_days %>% filter(Logger_ID == climate_logger_id)
  
  # Check if logger_data is empty
  if (nrow(logger_data) == 0) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Calculate the time difference between each climate measurement and the experiment's start time
  logger_data <- logger_data %>%
    mutate(time_diff = abs(difftime(Date_time, start_time, units = "mins")))
  
  # Find the index of the closest measurement
  if (all(is.na(logger_data$time_diff))) {
    # Add a row of NAs if time differences cannot be computed
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  start_index <- which.min(logger_data$time_diff)
  
  # Check if start_index is valid
  if (length(start_index) == 0 || is.na(start_index)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Extract the next 9 measurements (starting from the closest measurement)
  end_index <- min(start_index + 8, nrow(logger_data))  # Ensure we don't exceed the number of rows
  experiment_period_data <- logger_data[start_index:end_index, ]
  
  # Add Sample_ID to the extracted data for traceability
  experiment_period_data$Sample_ID <- i
  
  # Combine the result into the main data frame
  experiment_climate_data <- bind_rows(experiment_climate_data, experiment_period_data)
}

# Check the first few rows of the result
head(experiment_climate_data)
length(unique(experiment_climate_data$Sample_ID))

# Re-order the columns to have the Sample ID first
experiment_climate_data <- cbind(experiment_climate_data[,9], experiment_climate_data[,1:8])
colnames(experiment_climate_data) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# save the result to a CSV
write.csv(experiment_climate_data, "../data/env_data_loggers/env_data_2024.csv", row.names = FALSE)
```


#### 4. Cleaning and preparing environmental data files

I  now have 1 data file per year which contains 9 climate logger measurements per ant picnic experiment. These measurement should span the duration of the experiment. However, since the loggers measure always at XX:00, XX:15, XX:30, XX:45, and the experiment start times are more varied than that, some of the climate logger measures may have been taken before the start or after the end of the experiment, when the climate logger was not in the ground. This would give irrelevant measures. Thus, I want to check whether I need to exclude some climate logger measures before extracting mean temperature and soil moisture during my experiments.

In order to do that, I will plot the soil moisture values over time. If a measure was taken while the logger was out of the soil, the soil moisture measure should be drastically different, and there should be very visible outliers when plotted.

2024 has no missing data. However, both 2022 and 2023 have some missing values, e.g. because the climate logger ID or the starting time were not given. For 2023 and 2022, I  will first have to check the experiments for which the loop returned only 1 row of missing values and see whether some data can be recovered.

##### 4.1 2024

```{r 4.1.1 quality check 2024}
# clean environment since these steps are unrelated to the previous steps
rm(list=ls()) 

# load data
env_2024 <- read.csv("../data/env_data_loggers/env_data_2024.csv", header = T)
# turn Date_time into POSIXct object
env_2024$Date_time <- ymd_hms(env_2024$Date_time)

# plot moisture over the 120 minutes of the experiment in chunks of 15 experiments

# Define the number of rows per plot and the total number of rows
rows_per_plot <- 135 # 15 exp * 9 measures = 135 rows
total_rows <- nrow(env_2024)

# Calculate the number of plots needed
num_plots <- ceiling(total_rows / rows_per_plot)

# Loop through each chunk
for (i in seq_len(num_plots)) {
  # Define the row range for this chunk
  start_row <- (i - 1) * rows_per_plot + 1
  end_row <- min(i * rows_per_plot, total_rows)  # Ensure not to exceed total rows
  
  # Extract the chunk of data
  data_chunk <- env_2024[start_row:end_row, ]
  
  # Create the plot for this chunk
  plot <- ggplot(data_chunk, aes(
      x = as.numeric(time_diff),
      y = as.numeric(Vol_soil_moisture),
      group = as.factor(Sample_ID),
      color = as.factor(Sample_ID)
    )) +
    geom_smooth(se = F) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 12),
      legend.position = "right"
    ) +
    labs(
      x = "Time since experiment start",
      y = "Volumetric soil moisture [%]",
      color = "Sample ID",
      title = paste("Soil Moisture: Rows", start_row, "to", end_row)
    )
  
  # Print the plot to the console (for interactive use)
  print(plot)
  
  # Optionally save each plot to a file
  ggsave(
    filename = paste0("../images/logger_cleaning/2024_moisture_over_time_plot_", i, ".png"),
    plot = plot,
    width = 8, height = 6
  )
}
```


```{r 4.1.2 clean 2024 data pt 1: remove problematic rows}
# load data if necessary
# env_2024 <- read.csv("../data/eenv_data_loggers/nv_data_2024.csv", header = T)

# list of problematic samples (created manually by looking at which sample IDs did not have a flat line in the graphs)
problem_samples <- c("24-11002", "24-11005", "24-11015", "24-11039", "24-11059", "24-11069", "24-11075", "24-11087", "24-11091", "24-11093", "24-11095")

# create new cleaned data frame with all the env_2024 data
env_2024_clean <- env_2024

# print climate measures from sample 1 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[1],])
# 1st measure of soil moisture is an outlier and was taken before start of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[1] & env_2024_clean$time_diff == 6),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[1],])

# print climate measures from sample 2 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[2],])
# last measure of soil moisture is an outlier and was taken after end of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[2] & env_2024_clean$time_diff == 126),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[2],])

# print climate measures from sample 3 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[3],])
# 1st measure of soil moisture is a bit lower than the rest but not an extreme outlier, discussed with supervisor and left as is

# print climate measures from sample 4 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[4],])
# last measure of soil moisture is an outlier and was taken after end of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[4] & env_2024_clean$time_diff == 125),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[4],])

# print climate measures from sample 5 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[5],])
# 1st measure of soil moisture is an outlier and was taken before start of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[5] & env_2024_clean$time_diff == 6),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[5],])

# print climate measures from sample 6 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[6],])
# last measure of soil moisture is an outlier and was taken after end of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[6] & env_2024_clean$time_diff == 125),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[6],])

# print climate measures from sample 7 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[7],])
# 1st measure of soil moisture is an outlier and was taken before start of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[7] & env_2024_clean$time_diff == 1),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[7],])

# print climate measures from sample 8 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[8],])
# 1st measure of soil moisture is an outlier and was taken before start of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[8] & env_2024_clean$time_diff == 2),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[8],])

# print climate measures from sample 9 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[9],])
# 1st measure of soil moisture is an outlier and was taken before start of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[9] & env_2024_clean$time_diff == 3),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[9],])

# print climate measures from sample 10 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[10],])
# last measure of soil moisture is an outlier and was taken after end of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[10] & env_2024_clean$time_diff == 127),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[10],])

# print climate measures from sample 11 in list of problematic samples
print(env_2024[env_2024$Sample_ID == problem_samples[11],])
# 1st measure of soil moisture is an outlier and was taken before start of exp, we remove this row from env_2024_clean
env_2024_clean <- env_2024_clean[-which(env_2024_clean$Sample_ID == problem_samples[11] & env_2024_clean$time_diff == 7),]
# check the row was removed correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_samples[11],])
```


```{r 4.1.3 clean 2024 data pt 2: extract additional measures}
# If needed, read climate data experiment days table
# climate_data_exp_days <- read.csv("../data/climate_loggers/climate_data_exp_days.csv", header = T)

# vector with sample IDs of sample where first logger measure had an issue (created manually)
problem_first_measure_24 <- problem_samples[c(1, 5, 7:9, 11)]

# create a subset of the times_2024 table which contains only the rows where the sample ID matches those in problem_first_measure
times_pb_first_24 <- times_2024[times_2024$Sample_ID %in% problem_first_measure_24,]

# Create a new data frame to store the result
experiment_climate_data <- data.frame()

# create a loop to extract the 10 closest entries to the start time (one more than was previously extracted in chunk 3.5)
for (i in times_pb_first_24$Sample_ID) {
  
  # Extract experiment row (for this specific Sample_ID)
  experiment_row <- times_pb_first_24 %>% filter(Sample_ID == i)
  
  # Extract the experiment's start time and the associated climate logger ID
  start_time <- experiment_row$Date_time
  climate_logger_id <- experiment_row$Climate_logger_ID
  
  # Check if the climate logger ID is NA
  if (is.na(climate_logger_id)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = NA,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Filter the climate data for the relevant climate logger
  logger_data <- climate_data_exp_days %>% filter(Logger_ID == climate_logger_id)
  
  # Check if logger_data is empty
  if (nrow(logger_data) == 0) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Calculate the time difference between each climate measurement and the experiment's start time
  logger_data <- logger_data %>%
    mutate(time_diff = abs(difftime(Date_time, start_time, units = "mins")))
  
  # Find the index of the closest measurement
  if (all(is.na(logger_data$time_diff))) {
    # Add a row of NAs if time differences cannot be computed
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  start_index <- which.min(logger_data$time_diff)
  
  # Check if start_index is valid
  if (length(start_index) == 0 || is.na(start_index)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Extract the next 9 measurements (starting from the closest measurement)
  end_index <- min(start_index + 9, nrow(logger_data))  # Ensure we don't exceed the number of rows
  experiment_period_data <- logger_data[start_index:end_index, ]
  
  # Add Sample_ID to the extracted data for traceability
  experiment_period_data$Sample_ID <- i
  
  # Combine the result into the main data frame
  experiment_climate_data <- bind_rows(experiment_climate_data, experiment_period_data)
}

# Re-order the columns to have the Sample ID first
experiment_climate_data <- cbind(experiment_climate_data[,9], experiment_climate_data[,1:8])
colnames(experiment_climate_data) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# for all the samples in problem_first_measure_24, the 10th measure is just as problematic as the first. Adding that measure in order to have 9 climate measurements would not make sense.


# vector with sample IDs of sample where last logger measure had an issue (created manually)
problem_last_measure_24 <- problem_samples[c(2, 4, 6, 10)] 

# create a subset of the times_2024 table which contains only the rows where the sample ID matches those in problem_first_measure
times_pb_last_24 <- times_2024[times_2024$Sample_ID %in% problem_last_measure_24,]

# Create a new data frame to store the result
experiment_climate_data <- data.frame()

# create a loop to extract the 10 closest entries to the start time - 1 (to get one entry earlier than in chunk 3.5)
for (i in times_pb_last_24$Sample_ID) {
  
  # Extract experiment row (for this specific Sample_ID)
  experiment_row <- times_pb_last_24 %>% filter(Sample_ID == i)
  
  # Extract the experiment's start time and the associated climate logger ID
  start_time <- experiment_row$Date_time
  climate_logger_id <- experiment_row$Climate_logger_ID
  
  # Check if the climate logger ID is NA
  if (is.na(climate_logger_id)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = NA,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Filter the climate data for the relevant climate logger
  logger_data <- climate_data_exp_days %>% filter(Logger_ID == climate_logger_id)
  
  # Check if logger_data is empty
  if (nrow(logger_data) == 0) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Calculate the time difference between each climate measurement and the experiment's start time
  logger_data <- logger_data %>%
    mutate(time_diff = abs(difftime(Date_time, start_time, units = "mins")))
  
  # Find the index of the closest measurement
  if (all(is.na(logger_data$time_diff))) {
    # Add a row of NAs if time differences cannot be computed
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  start_index <- which.min(logger_data$time_diff) - 1
  
  # Check if start_index is valid
  if (length(start_index) == 0 || is.na(start_index)) {
    # Add a row of NAs with the current Sample_ID
    experiment_climate_data <- bind_rows(
      experiment_climate_data,
      data.frame(
        Sample_ID = i,
        Logger_ID = climate_logger_id,
        Date_time = start_time,
        T1 = NA,
        T2 = NA,
        T3 = NA,
        Raw_soil_moisture = NA,
        Vol_soil_moisture = NA,
        time_diff = NA
      )
    )
    next  # Skip to the next iteration
  }
  
  # Extract the next 9 measurements (starting from the closest measurement)
  end_index <- min(start_index + 9, nrow(logger_data))  # Ensure we don't exceed the number of rows
  experiment_period_data <- logger_data[start_index:end_index, ]
  
  # Add Sample_ID to the extracted data for traceability
  experiment_period_data$Sample_ID <- i
  
  # Combine the result into the main data frame
  experiment_climate_data <- bind_rows(experiment_climate_data, experiment_period_data)
}

# Re-order the columns to have the Sample ID first
experiment_climate_data <- cbind(experiment_climate_data[,9], experiment_climate_data[,1:8])
colnames(experiment_climate_data) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# some of the new measures have coherent soil moisture values, adding them to the 2024 data makes sense.

# create data frame for values we want to add
to_add_2024 <- experiment_climate_data
```

For all the samples in problem_first_measure_24, the 10th measure is just as problematic as the first. Adding that measure in order to have 9 climate measurements would not make sense.

For the samples for which the last climate logger measure was not relevant, there is one case in which the 1st measure is just as irrelevant: sample 24-11005. For the 3 others (24-11039, 24-11069, 24-11093), taking one measure earlier than the measure closest to the starting time yields coherent soil moisture results. However, that measure is respectively 10 minutes, 10 minutes and 8 minutes before the start of the experiment. 

I will add these additional measures to the env_2024_clean data frame, and save that data frame as a .csv file which contains all the climate logger data for the year 2024.

```{r 4.1.4 clean 2024 data pt 3: adding relevant logger measures}

# print climate measures from sample 1 in list of problematic samples where the last measure was removed
print(to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[1],])
# the earlier measure we extracted is just as problematic, this sample will keep its 8 measures

# print climate measures from sample 2 in list of problematic samples where the last measure was removed
print(to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[2],])
# the earlier measure we extracted is coherent with the rest of the measures, we can add it to the clean data
env_2024_clean <- rbind(env_2024_clean, to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[2] & to_add_2024$time_diff == 10,])
# check the row was added correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_last_measure_24[2],])

# print climate measures from sample 3 in list of problematic samples where the last measure was removed
print(to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[3],])
# the earlier measure we extracted is coherent with the rest of the measures, we can add it to the clean data
env_2024_clean <- rbind(env_2024_clean, to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[3] & to_add_2024$time_diff == 10,])
# check the row was added correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_last_measure_24[3],])

# print climate measures from sample 4 in list of problematic samples where the last measure was removed
print(to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[4],])
# the earlier measure we extracted is coherent with the rest of the measures, we can add it to the clean data
env_2024_clean <- rbind(env_2024_clean, to_add_2024[to_add_2024$Sample_ID == problem_last_measure_24[4] & to_add_2024$time_diff == 8,])
# check the row was added correctly
print(env_2024_clean[env_2024_clean$Sample_ID == problem_last_measure_24[4],])


# re-order the clean 2024 data frame by sample ID and date time.
env_2024_clean <- env_2024_clean %>%
  arrange(Sample_ID, Date_time)
```

Now that my 2024 climate data is cleaned, I will save the cleaned data in a .csv file then extract mean, minimum and maximum values per experiment for each climate measure and save that data into a new .csv file.

```{r 4.1.5 saving 2024 climate data}
# save complete 2024 cleaned data to a csv file
write.csv(env_2024_clean, "../data/env_data_loggers/env_data_2024_clean.csv", row.names = FALSE)

## Extracting mean, min, max values per experiment

# ensure logger measured are treated as numeric objects
env_2024_clean$T1 <- as.numeric(env_2024_clean$T1)
env_2024_clean$T2 <- as.numeric(env_2024_clean$T2)
env_2024_clean$T3 <- as.numeric(env_2024_clean$T3)
env_2024_clean$Raw_soil_moisture <- as.numeric(env_2024_clean$Raw_soil_moisture)
env_2024_clean$Vol_soil_moisture <- as.numeric(env_2024_clean$Vol_soil_moisture)

# calculate mean, min and max of climate logger data

env_data_2024_means <- data.frame()

for (i in unique(env_2024_clean$Sample_ID)) {
  sample_measures <- subset(env_2024_clean, env_2024_clean$Sample_ID  == i)
  
  T1_mean <-mean(sample_measures$T1)
  T1_max <-max(sample_measures$T1)
  T1_min <-min(sample_measures$T1)
  T1_sd <-sd(sample_measures$T1, na.rm = T)
  T1_var <-var(sample_measures$T1, na.rm = T)
  
  T2_mean <-mean(sample_measures$T2)
  T2_max <-max(sample_measures$T2)
  T2_min <-min(sample_measures$T2)
  T2_sd <-sd(sample_measures$T2, na.rm = T)
  T2_var <-var(sample_measures$T2, na.rm = T)
  
  T3_mean <-mean(sample_measures$T3)
  T3_max <-max(sample_measures$T3)
  T3_min <-min(sample_measures$T3)
  T3_sd <-sd(sample_measures$T3, na.rm = T)
  T3_var <-var(sample_measures$T3, na.rm = T)
  
  Raw_moist_mean <-mean(sample_measures$Raw_soil_moisture)
  Raw_moist_max <-max(sample_measures$Raw_soil_moisture)
  Raw_moist_min<-min(sample_measures$Raw_soil_moisture)
  Raw_moist_sd <-sd(sample_measures$Raw_soil_moisture, na.rm = T)
  Raw_moist_var <-var(sample_measures$Raw_soil_moisture, na.rm = T)
  
  Vol_moist_mean <-mean(sample_measures$Vol_soil_moisture)
  Vol_moist_max <-max(sample_measures$Vol_soil_moisture)
  Vol_moist_min <-min(sample_measures$Vol_soil_moisture)
  Vol_moist_sd <-sd(sample_measures$Vol_soil_moisture, na.rm = T)
  Vol_moist_var <-var(sample_measures$Vol_soil_moisture, na.rm = T)
  
  df <- cbind(i, T1_mean, T1_max, T1_min, T1_sd, T1_var, T2_mean, T2_max, T2_min, T2_sd, T2_var, T3_mean, T3_max, T3_min, T3_sd, T3_var, Raw_moist_mean, Raw_moist_max, Raw_moist_min, Raw_moist_sd, Raw_moist_var, Vol_moist_mean, Vol_moist_max, Vol_moist_min, Vol_moist_sd, Vol_moist_var)
  env_data_2024_means <- rbind(env_data_2024_means, df)
}

# create .csv file with calculated means for 2024 data
write.csv(env_data_2024_means, "../data/env_data_loggers/env_data_2024_means.csv", row.names = FALSE) 
```


##### 4.2 2023

I will first load the 2023 climate data file which should contain 9 measurements per experiment and check which experiments returned missing values, and whether some data can be recovered manually.

```{r 4.2.1 first look at 2023 climate data}
# load the 2023 extracted climate data
env_2023 <- read.csv("../data/env_data_loggers/env_data_2023.csv", header = T)

# overview of main information 
length(unique(env_2023$Sample_ID)) # check I have the correct number of experiments (should be 47)
table(env_2023$Sample_ID) # some sample IDs are found in only 1 row, meaning the extraction of climate values did not work
min(env_2023$time_diff, na.rm = T); max(env_2023$time_diff, na.rm = T) # check that the time differences between the measures and the start of the experiment are coherent

# obtain sample IDs found in only 1 row
freq_table <- table(env_2023$Sample_ID) # Create a frequency table
id_missing_clim_2023 <- names(freq_table[freq_table == 1]) # Extract Sample_IDs that occur only once
id_missing_clim_2023; length(id_missing_clim_2023) # there are 7 sample IDs which appear in only 1 row 

# check the sample IDs which appear once have no climate data
env_2023[env_2023$Sample_ID %in% id_missing_clim_2023,]
```

The loop used previously to extract the 9 measures closest to the experiment time was not able to extract data for 7 experiments. When compared with the Ant Picnic datasheet for 2023, 4 experiments (23-22052, 23-22057, 23-22058, 23-22069) had no climate logger ID given. For these experiments, it will be impossible to extract climate values.

Experiment 23-22045 had no given starting time. However, looking at the ant picnic data sheet shows that the experiment was done on 26.05.2023. Thus, I can have a look at all measures taken on that day by the corresponding climate logger. Plotting the soil moisture over the time of day shows very clear outliers from around 9 am (9:15) to 11 am (11:30). There are 10 outlier measures, which roughly spans the time required for an ant picnic experiment. I can retrieve these values as likely measures taken during the experiment and replace the row of missing values for this experiment with the measures obtained. The time differrence column will be filled with NA since we can't know the exact experiment starting time

The two remaining experiments (23-22041, 23-22061) have a logger ID and a starting time. However, the climate loggers are part of the 10 loggers which I was not able to locate and thus extract. Therefore, the data for these loggers will remain missing until I find the loggers again.

```{r 4.2.2 adding 2023 data with missing starting time}
# If needed, read climate data experiment days table
# climate_data_exp_days <- read.csv("../data/climate_loggers/climate_data_exp_days.csv", header = T)

# extract all logger measures taken on 26.05.2023 by the logger used in experiment 23-22045
log <- env_2023$Logger_ID[env_2023$Sample_ID == "23-22045"] # logger ID used in exp 23-22045
date <- dmy("26.05.2023")
env_day_2322045 <- climate_data_exp_days[climate_data_exp_days$Logger_ID == log & as.Date(climate_data_exp_days$Date_time) == as.Date(date),] # extract all measurements taken on 23-22045 exp day

# look for outliers in soil moisture over the time of day
env_day_2322045$Date_time <- ymd_hms(env_day_2322045$Date_time)
plot(env_day_2322045$Date_time, env_day_2322045$Vol_soil_moisture) # shows clear outliers in soil moisture, time where the logger was likely in the ground.

# find times where soil moisture values were higher than 0
exp_times <- env_day_2322045[env_day_2322045$Vol_soil_moisture > 0, ]
exp_times # the values are all between 9:15 and 11:30 am, which is coherent with other experiments done on that day in that school and roughly spans the time of an ant picnic experiment.

# replace missing values row with extracted measures to the env_2023 table

# remove row with NA values
env_2023 <- env_2023[-which(env_2023$Sample_ID == "23-22045"),] 
# check that 23-22045 was removed correctly and that there are only 46 exp left
unique(env_2023$Sample_ID); length(unique(env_2023$Sample_ID)) 

# create time_diff and sample ID column for the extracted measures
new_col_2322045 <- cbind(rep(NA, times = nrow(exp_times)), rep("23-22045", times = nrow(exp_times)))
colnames(new_col_2322045) <- c("time_diff", "Sample_ID")
exp_times <- cbind(exp_times, new_col_2322045)
# Re-order the columns to have the Sample ID first
exp_times <- cbind(exp_times[,9], exp_times[,1:8])
colnames(exp_times) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# ensure the date_time format is the same for both dataframes
exp_times$Date_time <- ymd_hms(exp_times$Date_time)
env_2023$Date_time <- ymd_hms(env_2023$Date_time)
# add the new measures to the env_2023 table and sort it by sample ID number
env_2023 <- rbind(env_2023, exp_times)
env_2023 <- env_2023[order(env_2023$Sample_ID),]

#save the data we added into a new file
write.csv(env_2023, "../data/env_data_loggers/env_data_2023_added.csv", row.names = FALSE)
```


Now that all the missing data I could retrieve has been added to the env_2023 table, I can proceed with the same steps performed for 2024.

```{r 4.2.3 quality check 2023}
# load data
env_2023 <- read.csv("../data/env_data_loggers/env_data_2023_added.csv", header = T)
# turn Date_time into POSIXct object
env_2023$Date_time <- ymd_hms(env_2023$Date_time)

# plot moisture over the 120 minutes of the experiment in chunks of 15 experiments

# Define the number of rows per plot and the total number of rows
rows_per_plot <- 135
total_rows <- nrow(env_2023)

# Calculate the number of plots needed
num_plots <- ceiling(total_rows / rows_per_plot)

# Loop through each chunk
for (i in seq_len(num_plots)) {
  # Define the row range for this chunk
  start_row <- (i - 1) * rows_per_plot + 1
  end_row <- min(i * rows_per_plot, total_rows)  # Ensure not to exceed total rows
  
  # Extract the chunk of data
  data_chunk <- env_2023[start_row:end_row, ]
  
  # Create the plot for this chunk
  plot <- ggplot(data_chunk, aes(
      x = as.numeric(time_diff),
      y = as.numeric(Vol_soil_moisture),
      group = as.factor(Sample_ID),
      color = as.factor(Sample_ID)
    )) +
    geom_smooth(se = F) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 12),
      legend.position = "right"
    ) +
    labs(
      x = "Time since experiment start",
      y = "Volumetric soil moisture [%]",
      color = "Sample ID",
      title = paste("Soil Moisture: Rows", start_row, "to", end_row)
    )
  
  # Print the plot to the console (for interactive use)
  print(plot)
  
  # Optionally save each plot to a file
  ggsave(
    filename = paste0("../images/logger_cleaning/2023_moisture_over_time_plot_", i, ".png"),
    plot = plot,
    width = 8, height = 6
  )
}
```

For 2023, many samples appear to have problems when looking at the plots of soil moisture over experiment time. Some have moisture values which are way too low to have been in the soil (0% moisture), and many have strong variations in the measures. I will go through every sample manually and see whether the data makes sense or not, and manually remove measures which are not relevant.

All sample IDs where checked, but I kept in the following chunk only the experiments which had issues, in order to lighten the code as much as possible.

```{r 4.2.4 manual clean climate data 2023}
# load data if necessary
# env_2023 <- read.csv("../data/env_data_loggers/env_data_2023.csv", header = T)

# turn Date_time into POSIXct object
env_2023$Date_time <- ymd_hms(env_2023$Date_time)

# create new data frame for cleaned data
env_2023_clean <- env_2023

# make list of 2023 sample IDs
sample_2023 <- unique(env_2023$Sample_ID)


# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[7]), ]
# 1st and last 3 measures are too low for the logger to have been in the ground, they need to be removed.
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[7] & env_2023_clean$time_diff %in% c(2, 88, 103, 118)),]
# I checked manually the values close to the beginning and end of the experiment in Excel and the soil moisture was too low again, so this sample will only have 5 measures.
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[7]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[8]), ]
# 1st row of measures for 23-22002 is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[8] & env_2023_clean$time_diff == 5),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[8]), ]
# I checked manually the value for 13:30 in Excel and the soil moisture was too low again, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[9]), ]
# the last 3 measures (12:45, 13:00, 13:15) have soil moisture values which are too low, so these rows need to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[9] & env_2023_clean$time_diff >= 90),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[9]), ]
# I checked manually the values for before 11:15 in Excel and the soil moisture was too low again, so this sample will only have 6 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[10]), ]
# looks good, no changes needed

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[11]), ]
# all soil moistures are too low. Looking at the data in Excel, this climate logger was not used on the experiment day (no change in soil moisture over 24h). The only other time this logger was used in 2023 was for the pitfall trap (1 week continuously high soil moisture values). 
# measures for 23-22009 need to be removed and replaced by a row of NAs
env_2023_clean[env_2023_clean$Sample_ID == sample_2023[11], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[11]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[15]), ]
# last row of measures for 23-22025 is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[15] & env_2023_clean$time_diff == 126),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[15]), ]
# I checked manually the value for 11:45 in Excel and the soil moisture was too low again, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[16]), ]
# all soil moisture values measured by this logger in 2023 are below 600, this logger was not used. Maybe the participants wrote the logger number wrong. during the experiment time, the first measure is at 581 but all others are around 440 
# measures for 23-22028 need to be removed and replaced by a row of NAs
env_2023_clean[env_2023_clean$Sample_ID == sample_2023[16], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[16]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[18]), ]
# looking at the data in Excel, the measures at 10:45 and 12:45 are very high, while the measures in between are much lower (around 560). Still, the middle measures are around 100 higher than measure for the rest of that day
# measure at 13:00 is too low, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[18] & env_2023_clean$time_diff == 125),]
# measure at 10:45 has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94226773),
  Date_time = dmy_hm("31.05.2023 10:45"),
  T1 = 25.75,
  T2 = 25.125,
  T3 = 24.625,
  Raw_soil_moisture = as.integer(2199),
  Vol_soil_moisture = 32.6,
  time_diff = as.integer(10),  # measure taken at 10:45 but exp starting time is 10:55, 10 minute difference
  Sample_ID = "23-22030")
env_2023_clean <- bind_rows(env_2023_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2023_clean <- env_2023_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[18]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[19]), ]
# last row of measures for 23-22033 is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[19] & env_2023_clean$time_diff == 125),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[19]), ]
# I checked manually the value for 11:30 in Excel and the soil moisture was too low again, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[20]), ]
# 1st and last row of measures for 23-22035 are outliers, need to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[20] & env_2023_clean$time_diff == 5),]
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[20] & env_2023_clean$time_diff == 115),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[20]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 7 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[23]), ]
# last row of measures for 23-22042 is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[23] & env_2023_clean$time_diff == 125),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[23]), ]
# measure at 12:00 has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94226791),
  Date_time = dmy_hm("06.09.2023 12:00"),
  T1 = 30.5625,
  T2 = 27.625,
  T3 = 28,
  Raw_soil_moisture = as.integer(856), 	
  Vol_soil_moisture = 4.6,
  time_diff = as.integer(10),  # measure taken at 12:00 but exp starting time is 12:10, 10 minute difference
  Sample_ID = "23-22042")
env_2023_clean <- bind_rows(env_2023_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2023_clean <- env_2023_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[23]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[24]), ]
# 1st and 2 last rowsof measures for 23-22035 are outliers, need to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[24] & env_2023_clean$time_diff == 3),]
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[24] & env_2023_clean$time_diff == 102),]
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[24] & env_2023_clean$time_diff == 117),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[24]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 6 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[26]), ]
# last row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[26] & env_2023_clean$time_diff == 120),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[26]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[27]), ]
# last row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[27] & env_2023_clean$time_diff == 127),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[27]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[28]), ]
# the measures are too low and too constant compared with the measures from the rest of the experiment day, the logger was not used on the exp day. It appears to only have been used in 2023 for the pitfall trap (continuous high moisture for a week). 
# measures for 23-22049 need to be removed and replaced by a row of NAs
env_2023_clean[env_2023_clean$Sample_ID == sample_2023[28], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[28]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[29]), ]
# 1st row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[29] & env_2023_clean$time_diff == 7),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[29]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[34]), ]
# 1st row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[34] & env_2023_clean$time_diff == 6),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[34]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[35]), ]
# last row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[35] & env_2023_clean$time_diff == 120),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[35]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[36]), ]
# last row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[36] & env_2023_clean$time_diff == 124),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[36]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[37]), ]
# the measures from 11:30 to 12:45 are too low and too constant compared with the measures from the rest of the experiment day, the logger was not in the ground at that time. These rows need to be removed. However, the logger has high moisture values from 09:15-10:30 consistent with those from 10:45-11:15. These are slightly before the reported experiment start, but I will add them to the data for now.
# removing last 6 rows
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[37] & env_2023_clean$time_diff %in% c(47, 62, 77, 92, 107, 122)),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[37]), ]
# create new data frame copying data from .csv file of climate logger
new_row <- data.frame(
  Logger_ID = rep(as.integer(94226712), times = 6),
  Date_time = dmy_hm(c("26/05/2023 09:15", "26/05/2023 09:30", "26/05/2023 09:45", "26/05/2023 10:00", "26/05/2023 10:15", "26/05/2023 10:30")),
  T1 = c(17.5625, 17.875, 18, 18.0625, 18.125, 18.25),
  T2 = c(17.875, 17, 16.75, 17, 17.125, 17.6875),
  T3 = c(17.5, 16.75, 16.625, 17, 17.125, 17.75),
  Raw_soil_moisture = as.integer(c(1117, 1113, 1117, 1054, 1058, 1062)), 	
  Vol_soil_moisture = c(10.4, 10.3, 10.4, 9, 9.1, 9.2),
  time_diff = as.integer(c(88, 73, 58, 43, 28, 13)),  # exp starting time is 10:43, calculated by hand the time difference with each measure (see date_time)
  Sample_ID = rep("23-22067", times = 6))
# add new rows
env_2023_clean <- bind_rows(env_2023_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2023_clean <- env_2023_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[37]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[38]), ]
# last row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[38] & env_2023_clean$time_diff == 120),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[38]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[40]), ]
# 1st row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[40] & env_2023_clean$time_diff == 0),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[40]), ]
# measure at 11:15 has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94233324),
  Date_time = dmy_hm("26/05/2023 11:15"),
  T1 = 15.25,
  T2 = 16.3125,
  T3 = 16.625,
  Raw_soil_moisture = as.integer(1411),
  Vol_soil_moisture = 16.8,
  time_diff = as.integer(135),  # measure taken at 11:15 but exp starting time is 09:00, 135 minute difference
  Sample_ID = "23-22070")
env_2023_clean <- bind_rows(env_2023_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2023_clean <- env_2023_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[40]), ]

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[41]), ]
# 1st 7 soil moisture measures around 1300, last 2 measures around 890. When looking at the logger data on Excel, measures stay around 900-800 until 10.07.2023. Before the exp, soil moisture is at around 490. Maybe the climate logger was still in the ground for the last 2 values I have. I keep these values for now.
				
# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[43]), ]			
# last row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[43] & env_2023_clean$time_diff == 125),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[43]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[44]), ]
# 1st row of measures is an outlier, needs to be removed
env_2023_clean <- env_2023_clean[-which(env_2023_clean$Sample_ID == sample_2023[44] & env_2023_clean$time_diff == 6),]
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[44]), ]
# I checked manually the values around the experiment time in Excel and the soil moisture was too low, so this sample will only have 8 measures.

# load the climate measures for a given sample ID
env_2023[which(env_2023$Sample_ID == sample_2023[46]), ]
# all soil moisture values are too low. Looking at the data in Excel, this climate logger was not used on the experiment day (no change in soil moisture over 24h). The only other time this logger was used in 2023 was for the pitfall trap (1 week continuously high soil moisture values). 
# measures for 23-22089 need to be removed and replaced by a row of NAs
env_2023_clean[env_2023_clean$Sample_ID == sample_2023[46], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2023_clean[which(env_2023_clean$Sample_ID == sample_2023[46]), ]
```
Notes on manual cleaning of samples:  

* Sample 23-22009: all soil moisture values from logger 94233331 are too low (0%). Looking at the data in Excel, this climate logger was not used on the experiment day (no change in soil moisture over 24h). The only other time this logger was used in 2023 was for the pitfall trap (1 week continuously high soil moisture values). 

* Sample 23-22028: all soil moisture values measured by this logger 94253287 in 2023 are below 600 (0%), this logger was not used. Maybe the participants wrote the logger number wrong. during the experiment time, the first measure is at 581 but all others are around 440 

* Sample 23-22049: the measures are too low and too constant compared with the measures from the rest of the experiment day, the logger 94226718 was not used on the exp day. It appears to only have been used in 2023 for the pitfall trap (continuous high moisture for a week). 

* Sample 23-22089: all soil moisture values from logger 94253271 are = 0%. Looking at the data in Excel, this climate logger was not used on the experiment day (no change in soil moisture over 24h). The only other time this logger was used in 2023 was for the pitfall trap (1 week continuously high soil moisture values). All measures replaced by NA


Now that the 2023 climate logger data has been manually checked and cleaned, we can plot the soil moisture again and see if the soil moisture values stay relatively constant throughout the experiment time. 

```{r 4.2.5 quality check clean data 2023}
# plot moisture over the 120 minutes of the experiment in chunks of 15 experiments

# Define the number of rows per plot and the total number of rows
rows_per_plot <- 135
total_rows <- nrow(env_2023_clean)

# Calculate the number of plots needed
num_plots <- ceiling(total_rows / rows_per_plot)

# Loop through each chunk
for (i in seq_len(num_plots)) {
  # Define the row range for this chunk
  start_row <- (i - 1) * rows_per_plot + 1
  end_row <- min(i * rows_per_plot, total_rows)  # Ensure not to exceed total rows
  
  # Extract the chunk of data
  data_chunk <- env_2023_clean[start_row:end_row, ]
  
  # Create the plot for this chunk
  plot <- ggplot(data_chunk, aes(
      x = as.numeric(time_diff),
      y = as.numeric(Vol_soil_moisture),
      group = as.factor(Sample_ID),
      color = as.factor(Sample_ID)
    )) +
    geom_smooth(se = F) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 12),
      legend.position = "right"
    ) +
    labs(
      x = "Time since experiment start",
      y = "Volumetric soil moisture [%]",
      color = "Sample ID",
      title = paste("Soil Moisture: Rows", start_row, "to", end_row)
    )
  
  # Print the plot to the console (for interactive use)
  print(plot)
  
  # Optionally save each plot to a file
  ggsave(
    filename = paste0("../images/logger_cleaning/2023_clean_moisture_over_time_plot_", i, ".png"),
    plot = plot,
    width = 8, height = 6
  )
}
```


There is still some variation but the data looks much more even. Now that my 2023 climate data is cleaned, I will save the cleaned data in a .csv file then extract mean, minimum and maximum values per experiment for each climate measure and save that data into a new .csv file.

```{r 4.2.6 saving 2023 climate data}
# save complete 2023 cleaned data to a csv file
write.csv(env_2023_clean, "../data/env_data_loggers/env_data_2023_clean.csv", row.names = FALSE)

## Extracting mean, min, max values per experiment

# ensure logger measured are treated as numeric objects
env_2023_clean$T1 <- as.numeric(env_2023_clean$T1)
env_2023_clean$T2 <- as.numeric(env_2023_clean$T2)
env_2023_clean$T3 <- as.numeric(env_2023_clean$T3)
env_2023_clean$Raw_soil_moisture <- as.numeric(env_2023_clean$Raw_soil_moisture)
env_2023_clean$Vol_soil_moisture <- as.numeric(env_2023_clean$Vol_soil_moisture)

# calculate mean, min and max of climate logger data

env_data_2023_means <- data.frame()

for (i in unique(env_2023_clean$Sample_ID)) {
  sample_measures <- subset(env_2023_clean, env_2023_clean$Sample_ID  == i)
  
  T1_mean <-mean(sample_measures$T1)
  T1_max <-max(sample_measures$T1)
  T1_min <-min(sample_measures$T1)
  T1_sd <-sd(sample_measures$T1, na.rm = T)
  T1_var <-var(sample_measures$T1, na.rm = T)
  
  T2_mean <-mean(sample_measures$T2)
  T2_max <-max(sample_measures$T2)
  T2_min <-min(sample_measures$T2)
  T2_sd <-sd(sample_measures$T2, na.rm = T)
  T2_var <-var(sample_measures$T2, na.rm = T)
  
  T3_mean <-mean(sample_measures$T3)
  T3_max <-max(sample_measures$T3)
  T3_min <-min(sample_measures$T3)
  T3_sd <-sd(sample_measures$T3, na.rm = T)
  T3_var <-var(sample_measures$T3, na.rm = T)
  
  Raw_moist_mean <-mean(sample_measures$Raw_soil_moisture)
  Raw_moist_max <-max(sample_measures$Raw_soil_moisture)
  Raw_moist_min<-min(sample_measures$Raw_soil_moisture)
  Raw_moist_sd <-sd(sample_measures$Raw_soil_moisture, na.rm = T)
  Raw_moist_var <-var(sample_measures$Raw_soil_moisture, na.rm = T)
  
  Vol_moist_mean <-mean(sample_measures$Vol_soil_moisture)
  Vol_moist_max <-max(sample_measures$Vol_soil_moisture)
  Vol_moist_min <-min(sample_measures$Vol_soil_moisture)
  Vol_moist_sd <-sd(sample_measures$Vol_soil_moisture, na.rm = T)
  Vol_moist_var <-var(sample_measures$Vol_soil_moisture, na.rm = T)
  
  df <- cbind(i, T1_mean, T1_max, T1_min, T1_sd, T1_var, T2_mean, T2_max, T2_min, T2_sd, T2_var, T3_mean, T3_max, T3_min, T3_sd, T3_var, Raw_moist_mean, Raw_moist_max, Raw_moist_min, Raw_moist_sd, Raw_moist_var, Vol_moist_mean, Vol_moist_max, Vol_moist_min, Vol_moist_sd, Vol_moist_var)
  env_data_2023_means <- rbind(env_data_2023_means, df)
}

# create .csv file with calculated means for 2023 data
write.csv(env_data_2023_means, "../data/env_data_loggers/env_data_2023_means.csv", row.names = FALSE) 

```


##### 4.3 2022

Just as I did for 2023, I will first load the 2022 climate data file which should contain 9 measurements per experiment. I will check which experiments returned missing values, and whether some data can be recovered manually.

```{r 4.3.1 first look at 2022 climate data}
# load the 2022 extracted climate data
env_2022 <- read.csv("../data/env_data_loggers/env_data_2022.csv", header = T)

# overview of main information 
length(unique(env_2022$Sample_ID)) # check I have the correct number of experiments (should be 82)
table(env_2022$Sample_ID) # some sample IDs are found in only 1 row, meaning the extraction of climate values did not work
min(env_2022$time_diff, na.rm = T); max(env_2022$time_diff, na.rm = T) # check that the time differences between the measures and the start of the experiment are coherent

# obtain sample IDs found in only 1 row
freq_table <- table(env_2022$Sample_ID) # Create a frequency table
id_missing_clim_2022 <- names(freq_table[freq_table == 1]) # Extract Sample_IDs that occur only once
id_missing_clim_2022; length(id_missing_clim_2022) # there are 18 sample IDs which appear in only 1 row 

# check the sample IDs which appear once have no climate data
no_data_2022 <- env_2022[env_2022$Sample_ID %in% id_missing_clim_2022,]; print(no_data_2022)

# load ID numbers of missing loggers
missing_loggers <- read.csv("../data/climate_loggers/missing_climate_loggers.csv")
# print ID numbers which are in the missing loggers list
print(no_data_2022[no_data_2022$Logger_ID %in% missing_loggers$Climate_logger_ID,])
```

The loop used previously to extract the 9 measures closest to the experiment time was not able to extract data for 18 experiments. When compared with the Ant Picnic datasheet for 2022, 5 experiments (22-11016, 22-11041, 22-11075, 22-11081, 22-11092) had no climate logger ID given. For these experiments, it will be impossible to extract climate values.

11 experiments (22-11029, 22-11030, 22-11037, 22-11039, 22-11048, 22-11053, 22-11058, 22-11073, 22-11078, 22-11088, 22-11098) have a logger ID and a starting time. However, the climate loggers are part of the 10 loggers which I was not able to locate and thus extract. Therefore, the data for these loggers will remain missing until I find the loggers again.

One experiment (22-11048) has a miswritten climate logger ID with 1 digit missing. Following the logic of the logger numbering system, its ID should be either 94226721 or 94226821. 94226821 is one of the missing loggers, so I cannot have a look at that data. However, data from logger number 94226721 was extracted. Looking at the data for the day the experiment was conducted shows that this logger was not used (soil moisture is 0 throughout the day). Furthermore, all other experiments done on that day at that school used the same logger, 94226821. This experiment thus very likely uses logger number 94226821. 

Another experiment (22-11061) had a logger ID miswritten with one digit missing. Following the logic of the logger numbering system, its ID should be either 94233324 or 94233424. I did not find logger 94233424 and thus was not able to extract the data, but I do have extracted data for logger ID 94233324. Looking at the data in Excel, this logger was used on the day of the experiment and had soil moisture values > 0 between 13:15 and 14:30. Since experiment 22-11061 started at 13:06, these values are highly likely to be measures taken during that experiment. Thus, logger 94233324 is very likely to be the one used during that experiment. I will add the measures where soil moisture was > 0. 

Experiment 22-11055 had no given starting time. Looking at the ant picnic data sheet shows that the experiment was done on 13.05.2022. I can have a look at all measures taken on that day by the corresponding climate logger. Plotting the soil moisture over the time of day shows very clear outliers from around 10:15 to 11:15. There are other outliers later in the day, but looking manually at the Excel table, the values stay high for 2 days which corresponds to the pitfall trap experiment. There are 5 outlier measures, which roughly spans the time required for half of an ant picnic experiment. Still, I can retrieve these values as likely measures taken during the experiment and replace the row of missing values for this experiment with the measures obtained. The time difference column will be filled with NA since we can't know the exact experiment starting time.

```{r 4.3.2 adding retrievable 2022 data}
# If needed, read climate data experiment days table
# climate_data_exp_days <- read.csv("../data/climate_loggers/climate_data_exp_days.csv", header = T)
# load the 2022 extracted climate data
# env_2022 <- read.csv("../data/env_data_loggers/env_data_2022_added.csv", header = T)

# exp 22-11061

# extract all logger measures taken on 19.05.2022 by the logger 94233324, most likely used in exp 22-11061
log <- "94233324"
date <- dmy("19.05.2022")
env_day_2211061 <- climate_data_exp_days[climate_data_exp_days$Logger_ID == log & as.Date(climate_data_exp_days$Date_time) == as.Date(date),] # extract all measurements taken on 23-22045 exp day

# look for outliers in soil moisture over the time of day
env_day_2211061$Date_time <- ymd_hms(env_day_2211061$Date_time)
plot(env_day_2211061$Date_time, env_day_2211061$Vol_soil_moisture) # shows clear outliers in soil moisture, time where the logger was likely in the ground.

# find times where soil moisture values were higher than 0
exp_times <- na.omit(env_day_2211061[env_day_2211061$Vol_soil_moisture > 0, ])
exp_times # the values are all between 13:15 and 14:30, which is coherent with the given experiment start time.

## replace missing values row with extracted measures to the env_2022 table

# remove row with NA values
env_2022 <- env_2022[-which(env_2022$Sample_ID == "22-11061"),] 
# check that 22-11061 was removed correctly and that there are only 81 exp left
length(unique(env_2022$Sample_ID)) 

# create time_diff and sample ID column for the extracted measures
new_col_2211061 <- cbind(c(9, 24, 39, 54, 69, 84), rep("22-11061", times = nrow(exp_times))) # time_diff calculated by hand with a given start time at 13:06
colnames(new_col_2211061) <- c("time_diff", "Sample_ID")
# add the new columns to the logger measures
exp_times <- cbind(exp_times, new_col_2211061)
# Re-order the columns to have the Sample ID first
exp_times <- cbind(exp_times[,9], exp_times[,1:8])
colnames(exp_times) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")
# make sure the time_diff column is in the correct format
exp_times$time_diff <- as.integer(exp_times$time_diff)

# ensure the date_time format is the same for both dataframes
exp_times$Date_time <- ymd_hms(exp_times$Date_time)
env_2022$Date_time <- ymd_hms(env_2022$Date_time)
# add the new measures to the env_2022 table and sort it by sample ID number
env_2022 <- rbind(env_2022, exp_times)
env_2022 <- env_2022[order(env_2022$Sample_ID),]



# exp 22-11055

# extract all logger measures taken on 13.05.2022 by the logger used in experiment 22-11055
log <- env_2022$Logger_ID[env_2022$Sample_ID == "22-11055"] # logger ID used in exp 22-11055
date <- dmy("13.05.2022")
env_day_2211055 <- climate_data_exp_days[climate_data_exp_days$Logger_ID == log & as.Date(climate_data_exp_days$Date_time) == as.Date(date),] # extract all measurements taken on 22-11055 exp day

# look for outliers in soil moisture over the time of day
env_day_2211055$Date_time <- ymd_hms(env_day_2211055$Date_time)
plot(env_day_2211055$Date_time, env_day_2211055$Vol_soil_moisture) # shows clear outliers in soil moisture, time where the logger was likely in the ground.

# find times where soil moisture values were higher than 0 before 18:00 (start of the pitfall trap experiment)
exp_times <- na.omit(env_day_2211055[hour(env_day_2211055$Date_time) < 18 & as.numeric(env_day_2211055$Vol_soil_moisture) > 0, ])
exp_times # the values are all between 10:15 and 11:15 am, which is coherent with other experiments done on that day in that school and roughly spans the time of an ant picnic experiment.

# replace missing values row with extracted measures to the env_2022 table

# remove row with NA values
env_2022 <- env_2022[-which(env_2022$Sample_ID == "22-11055"),] 
# check that 22-11055 was removed correctly and that there are only 81 exp left
unique(env_2022$Sample_ID); length(unique(env_2022$Sample_ID)) 

# create time_diff and sample ID column for the extracted measures
new_col_2211055 <- cbind(rep(NA, times = nrow(exp_times)), rep("22-11055", times = nrow(exp_times)))
colnames(new_col_2211055) <- c("time_diff", "Sample_ID")
exp_times <- cbind(exp_times, new_col_2211055)
# Re-order the columns to have the Sample ID first
exp_times <- cbind(exp_times[,9], exp_times[,1:8])
colnames(exp_times) <- c("Sample_ID", "Logger_ID", "Date_time", "T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")

# ensure the date_time format is the same for both dataframes
exp_times$Date_time <- ymd_hms(exp_times$Date_time)
env_2022$Date_time <- ymd_hms(env_2022$Date_time)
# add the new measures to the env_2023 table and sort it by sample ID number
env_2022 <- rbind(env_2022, exp_times)
env_2022 <- env_2022[order(env_2022$Sample_ID),]


#save the data we added into a new file
write.csv(env_2022, "../data/env_data_loggers/env_data_2022_added.csv", row.names = FALSE)
```

Now that all the missing data I could retrieve has been added to the env_2022 table, I can proceed with the same steps performed for 2024.

```{r 4.3.3 quality check 2022}
# load data if necessary
# env_2022 <- read.csv("../data/env_data_loggers/env_data_2022_added.csv", header = T)
# turn Date_time into POSIXct object
env_2022$Date_time <- ymd_hms(env_2022$Date_time)

# plot moisture over the 120 minutes of the experiment in chunks of 15 experiments

# Define the number of rows per plot and the total number of rows
rows_per_plot <- 135
total_rows <- nrow(env_2022)

# Calculate the number of plots needed
num_plots <- ceiling(total_rows / rows_per_plot)

# Loop through each chunk
for (i in seq_len(num_plots)) {
  # Define the row range for this chunk
  start_row <- (i - 1) * rows_per_plot + 1
  end_row <- min(i * rows_per_plot, total_rows)  # Ensure not to exceed total rows
  
  # Extract the chunk of data
  data_chunk <- env_2022[start_row:end_row, ]
  
  # Create the plot for this chunk
  plot <- ggplot(data_chunk, aes(
      x = as.numeric(time_diff),
      y = as.numeric(Vol_soil_moisture),
      group = as.factor(Sample_ID),
      color = as.factor(Sample_ID)
    )) +
    geom_smooth(se = F) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 12),
      legend.position = "right"
    ) +
    labs(
      x = "Time since experiment start",
      y = "Volumetric soil moisture [%]",
      color = "Sample ID",
      title = paste("Soil Moisture: Rows", start_row, "to", end_row)
    )
  
  # Print the plot to the console (for interactive use)
  print(plot)
  
  # Optionally save each plot to a file
  ggsave(
    filename = paste0("../images/logger_cleaning/2022_moisture_over_time_plot_", i, ".png"),
    plot = plot,
    width = 8, height = 6
  )
}
```

Just like 2023, many samples appear to have problems when looking at the plots of soil moisture over experiment time. Some have moisture values which are way too low to have been in the soil (0% moisture), and many have strong variations in the measures. I will go through every sample manually and see whether the data makes sense or not, and manually remove measures which are not relevant.

All sample IDs will be checked, but I keep in the following chunk only the experiments which had issues, in order to lighten the code as much as possible.

```{r 4.3.4 preparing manual cleaning}
# load data if necessary
# env_2022 <- read.csv("../data/env_data_loggers/env_data_2022_added.csv", header = T)

# turn Date_time into POSIXct object
env_2022$Date_time <- ymd_hms(env_2022$Date_time)

# create new data frame for cleaned data
env_2022_clean <- env_2022
env_2022_clean$time_diff <- as.integer(env_2022_clean$time_diff)

# make list of 2022 sample IDs
sample_2022 <- unique(env_2022$Sample_ID)

# to speed up the process, look at all experiments with no row where soil moisture = 0, where no changes should be needed
# filter for Sample IDs without any 0 in the Vol_soil_moisture column
samples_no_0_22 <- env_2022 %>%
  group_by(Sample_ID) %>%
  filter(all(Vol_soil_moisture != 0)) %>%
  summarise() %>%
  pull(Sample_ID)

# manual check that all experiments look normal, no huge jump in soil moisture, no zeros. 
# All experiments were looked at, only the ones with abnormal values were kept in the code for clarity.
env_2022[which(env_2022$Sample_ID == samples_no_0_22[2]), ]
# the first measure is higher than the rest (5.3% vs around 1%), not sure if it should be kept
env_2022[which(env_2022$Sample_ID == samples_no_0_22[4]), ]
# the first measure is much lower than the rest and was taken 5 minutes before start of exp, not sure if it should be kept (still > 0)


# filter for Sample_IDs with only NAs in the Vol_soil_moisture column
samples_NA_22 <- env_2022 %>%
  group_by(Sample_ID) %>%
  filter(all(is.na(Vol_soil_moisture))) %>%
  summarise() %>%
  pull(Sample_ID)

# manual check that all experiments indeed have NAs
env_2022[which(env_2022$Sample_ID %in% samples_NA_22), ] # 16 samples mentioned above in 4.3.1, as expected, no need for modification

# create a vector with only the experiments which have at least one 0 in the soil moisture column
samples_0_22 <- sample_2022[!sample_2022 %in% samples_no_0_22 & !sample_2022 %in% samples_NA_22]

# control that the total amount of samples IDs in the three new vectors is 82, the total number of experiments
length(samples_0_22)+length(samples_NA_22)+length(samples_no_0_22) == 82
```

When looking first at the experiments where no soil moisture measurements were equal to 0%, 2 experiments stand out:  

* 22-11003 has a first value which is much higher than the rest (5.3% versus around 1-1.5% for the rest of the experiment). 

* 22-11005 has a first value which is much lower than the rest of the experiment (0.5% versus ca. 10%). For now, these values were not removed.

```{r 4.3.5 manual cleaning of 2022 climate data}

## Chunk 4.3.4 needs to be run before running this chunk !!!

# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[1]), ]
# 1st and last soil moisture measures are too low for the logger to have been in the ground (0%), they need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[1] & env_2022_clean$time_diff %in% c(0, 120)),]
# I checked manually the values close to the beginning and end of the experiment in Excel and the soil moisture was too low again, so this sample will only have 7 measures.
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[1]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[2]), ]
# measures from 12:00 to 12:30 are too low (0%) and too constant compared with the measures from the rest of the experiment day, the logger was not in the ground at that time. These rows need to be removed. However, the logger has high moisture values from 09:45-10:15 consistent with those from 10:30-11:15. These are slightly before the reported experiment start, but I will add them to the data for now.
# removing last 3 rows
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[2] & env_2022_clean$time_diff %in% c(85, 100, 115)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[2]), ]
# create new data frame copying data from .csv file of climate logger
new_row <- data.frame(
  Logger_ID = rep(as.integer(94226718), times = 3),
  Date_time = dmy_hm(c("20/05/2022 09:45", "20/05/2022 10:00", "20/05/2022 10:15")),
  T1 = c(18, 17.5, 17.375),
  T2 = c(22.125, 19.9375, 19.375),
  T3 = c(20.75, 20.25, 20.125),
  Raw_soil_moisture = as.integer(c(1238, 1244, 1247)), 	
  Vol_soil_moisture = c(13.1, 13.2, 13.3),
  time_diff = as.integer(c(50, 35, 20)),  # exp starting time is 10:35, calculated by hand the time difference with each measure (see date_time)
  Sample_ID = rep("22-11006", times = 3))
# add new rows
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[2]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[3]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[3] & env_2022_clean$time_diff == 0),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[3]), ]
# measure at 12:15 has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94233343),
  Date_time = dmy_hm("25/05/2022 12:15"),
  T1 = 18.9375,
  T2 = 21.875,
  T3 = 21.5,
  Raw_soil_moisture = as.integer(1569),
  Vol_soil_moisture = 20.1,
  time_diff = as.integer(135),  # measure taken at 12:15 but exp starting time is 10:00, 135 minute difference
  Sample_ID = "22-11007")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[3]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[4]), ]						
# all soil moisture values are too low (0%). Looking at the data in Excel, no measure by this logger has a soil moisture over 0%, this logger was never used or the soil moisture measurement malfunctioned. 
# measures for 22-11008 need to be removed and replaced by a row of NAs
env_2022_clean[env_2022_clean$Sample_ID == samples_0_22[4], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[4]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[5]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[5] & env_2022_clean$time_diff == 2),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[5]), ]
# measure at 11:15 has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94226711),
  Date_time = dmy_hm("16/05/2022 11:15"),
  T1 = 18.0625,
  T2 = 20.75,
  T3 = 21,
  Raw_soil_moisture = as.integer(819),
  Vol_soil_moisture = 3.8,
  time_diff = as.integer(133),  # measure taken at 11:15 but exp starting time is 09:02, 133 minute difference
  Sample_ID = "22-11009")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[5]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[6]), ]
# measures from 09:00 to 09:30 are too low (0%) and too constant compared with the measures from the rest of the experiment day, the logger was not in the ground at that time. These rows need to be removed. However, the logger has high moisture values from 11:15-11:45 consistent with those from 09:45-11:00. These are slightly after the reported experiment start, but I will add them to the data for now.
# removing first 3 rows
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[6] & env_2022_clean$time_diff %in% c(5, 10, 25)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[6]), ]
# create new data frame copying data from .csv file of climate logger
new_row <- data.frame(
  Logger_ID = rep(as.integer(94226825), times = 3),
  Date_time = dmy_hm(c("20/05/2022 11:15", "20/05/2022 11:30", "20/05/2022 11:45")),
  T1 = c(18.6875, 18.6875, 18.8125),
  T2 = c(21.1875, 22.625, 24.25),
  T3 = c(22, 23.75, 25.5),
  Raw_soil_moisture = as.integer(c(1305, 1310, 1315)), 	
  Vol_soil_moisture = c(14.5, 14.6, 14.7),
  time_diff = as.integer(c(130, 145, 160)),  # exp starting time is 09:05, calculated by hand the time difference with each measure (see date_time)
  Sample_ID = rep("22-11010", times = 3))
# add new rows
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[6]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[7]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[7] & env_2022_clean$time_diff == 125),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[7]), ]
# measure at 13:30 has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94226715),
  Date_time = dmy_hm("06/06/2022 13:30"),
  T1 = 29.3125,
  T2 = 29.375,
  T3 = 28.625,
  Raw_soil_moisture = as.integer(1011),
  Vol_soil_moisture = 8.1,
  time_diff = as.integer(10),  # measure taken at 13:30 but exp starting time is 13:40, 10 minute difference
  Sample_ID = "22-11011")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[7]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[8]), ]
# 1st and last row of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[8] & env_2022_clean$time_diff %in% c(4, 124)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[8]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 7 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[9]), ]
# 1st row and last 2 rows of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[9] & env_2022_clean$time_diff %in% c(5, 110, 125)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[9]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 6 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[10]), ]
# all soil moisture values are too low (0%). Looking at the Excel files, all values for the experiment day are 0 until 20:00 when the soil values start being >0 continuously for 2 days, which corresponds to the timeline of the pitfall trap experiment
# measures for 22-11019 need to be removed and replaced by a row of NAs
env_2022_clean[env_2022_clean$Sample_ID == samples_0_22[10], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[10]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[11]), ]
# 1st and last row of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[11] & env_2022_clean$time_diff %in% c(7, 127)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[11]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 7 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[12]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[12] & env_2022_clean$time_diff == 5),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[12]), ]
# the soil moisture measures after 19:45 (or before 17:45) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[13]), ]
# last 2 rows of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[13] & env_2022_clean$time_diff %in% c(112, 127)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[13]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 7 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[14]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[14] & env_2022_clean$time_diff == 7),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[14]), ]
# the soil moisture measures after 11:45 (or before 09:45) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[15]), ]
# 1st 2 rows of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[15] & env_2022_clean$time_diff %in% c(1, 14)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[15]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 7 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[16]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[16] & env_2022_clean$time_diff == 116),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[16]), ]
# the soil moisture measures before 12:45 (or after 14:45) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[17]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[17] & env_2022_clean$time_diff == 125),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[17]), ]
# the soil moisture measures before 10:30 (or after 12:15) in the Excel sheet are = 0%, this experiment will only have 8 measures. All soil moisture values for this sample are very low (<1%).


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[18]), ]
# 1st and last row of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[18] & env_2022_clean$time_diff %in% c(6, 126)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[18]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 7 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[19]), ]
# 1st 2 rows and last row of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[19] & env_2022_clean$time_diff %in% c(3, 18, 123)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[19]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 6 measures. All soil moisture values for this sample are very low (<1%).


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[20]), ]
# all soil moisture values on day of experiment = 0%, climate logger was not used that day. In 2022, it was used for around 2 hours on 19.05 at 13:00 and on 20.05 at 12:00, then for two days between 20.05 and 22.05 for the pitfall trap experiment.
#  For now, measures for 22-11019 need to be removed and replaced by a row of NAs
env_2022_clean[env_2022_clean$Sample_ID == samples_0_22[20], c("T1", "T2", "T3", "Raw_soil_moisture", "Vol_soil_moisture", "time_diff")] <- NA
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[20]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[21]), ]
# 1st 2 rows and last row of measures have soil moisture too low (0%), need to be removed. Rows 3 & 4 also have a volumetric soil moisture value of 0%, but the raw value is much higher than the other 0% values (650 vs. 420), so I will keep them for now.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[21] & env_2022_clean$time_diff %in% c(4, 11, 116)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[21]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 6 measures. All soil moisture values for this sample are very low (<1%).


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[22]), ]
# 1st 2 rows of measures have soil moisture too low (0%), need to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[22] & env_2022_clean$time_diff %in% c(5, 10)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[22]), ]
# all soil moisture measures after 11:15 (or before 9:15) in the Excel sheet are = 0%, this experiment will only have 7 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[23]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[23] & env_2022_clean$time_diff == 125),]
# measure at 10:45 (10 min before exp start) has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94226716),
  Date_time = dmy_hm("20/05/2022 10:45"),
  T1 = 15.75,
  T2 = 21,
  T3 = 20.875,
  Raw_soil_moisture = as.integer(1166),
  Vol_soil_moisture = 11.5,
  time_diff = as.integer(10),  # measure taken at 10:45 but exp starting time is 10:55, 10 minute difference
  Sample_ID = "22-11054")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[23]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[24]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[24] & env_2022_clean$time_diff == 125),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[24]), ]
# the soil moisture measures before 9:45 (or after 11:45) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[25]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[25] & env_2022_clean$time_diff == 125),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[25]), ]
# the soil moisture measures before 17:45 (or after 19:45) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[26]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[26] & env_2022_clean$time_diff == 125),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[26]), ]
# the soil moisture measures before 10:15 (or after 12:15) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[27]), ]
# last row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[27] & env_2022_clean$time_diff == 127),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[27]), ]
# the soil moisture measures before 9:15 (or after 11:15) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[28]), ]
# 1st 2 rows and last row of measures have soil moisture too low (0%), need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[28] & env_2022_clean$time_diff %in% c(7, 22, 127)),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[28]), ]
# all soil moisture measures around the experiment time in the Excel sheet are = 0%, this experiment will only have 6 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[29]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[29] & env_2022_clean$time_diff == 0),]
# measure at 11:45 (15 min after exp end) has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94233344),
  Date_time = dmy_hm("31/05/2022 11:45"),
  T1 = 21.375,
  T2 = 19.25,
  T3 = 18.125,
  Raw_soil_moisture = as.integer(1056),
  Vol_soil_moisture = 9.1,
  time_diff = as.integer(135),  # measure taken at 11:45 but exp starting time is 9:30, 135 minute difference
  Sample_ID = "22-11071")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[29]), ]


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[30]), ]
# last 3 rows of measures have soil moisture too low (0%), need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[30] & env_2022_clean$time_diff %in% c(90, 105, 120)),]
# measure at 12:45 (15 min before exp start) has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same.
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94226791),
  Date_time = dmy_hm("19/05/2022 12:45"),
  T1 = 25,
  T2 = 29.3125,
  T3 = 29.875,
  Raw_soil_moisture = as.integer(1029),
  Vol_soil_moisture = 8.5,
  time_diff = as.integer(15),  # measure taken at 12:45 but exp starting time is 13:00, 15 minute difference
  Sample_ID = "22-11072")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[30]), ]
# All other measures around exp time have 0% soil moisture, this experiment will have 7 measures


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[31]), ]
# last 3 rows of measures have soil moisture too low (0%), need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[31] & env_2022_clean$time_diff %in% c(95, 110, 125)),]
# measure at 12:45 (10 min before exp start) has high soil moisture, we can add it manually by copying the excel data, making sure all data formats are the same.
# Create the data frame
new_row <- data.frame(
  Logger_ID = as.integer(94233317),
  Date_time = dmy_hm("19/05/2022 12:45"),
  T1 = 26.375,
  T2 = 28.75,
  T3 = 28.625,
  Raw_soil_moisture = as.integer(964),
  Vol_soil_moisture = 7,
  time_diff = as.integer(10),  # measure taken at 12:45 but exp starting time is 12:55, 10 minute difference
  Sample_ID = "22-11074")
env_2022_clean <- bind_rows(env_2022_clean, new_row)
# re-order the clean 2024 data frame by sample ID and date time.
env_2022_clean <- env_2022_clean %>%
  arrange(Sample_ID, Date_time)
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[31]), ]
# All other measures around exp time have 0% soil moisture, this experiment will have 7 measures


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[32]), ]
# last 3 rows of measures have soil moisture too low (0%), need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[32] & env_2022_clean$time_diff %in% c(95, 110, 125)),]
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[32]), ]
# measures between 14:15 and 15:00 have soil moisture = 0%, but 2 measures at 15:15 and 15:30 (35 and 50 min after exp end) have high soil moisture. For now, not added to dataset but the values are copied below in the code chunk. For now, this experiment has 6 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[33]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[33] & env_2022_clean$time_diff == 0),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[33]), ]
# the soil moisture measures after 12:15 (or before 10:15) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[34]), ]
# last 3 rows of measures have soil moisture too low (0%), need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[34] & env_2022_clean$time_diff %in% c(95, 110, 125)),]
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[34]), ]
# All other measures around exp time have 0% soil moisture, this experiment will have 6 measures


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[35]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[35] & env_2022_clean$time_diff == 0),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[35]), ]
# the soil moisture measures after 19:30 (or before 17:30) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[36]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[36] & env_2022_clean$time_diff == 2),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[36]), ]
# the soil moisture measures after 11:15 (or before 09:15) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[37]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[37] & env_2022_clean$time_diff == 5),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[37]), ]
# the soil moisture measures after 19:45 (or before 17:45) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[38]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[38] & env_2022_clean$time_diff == 5),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[38]), ]
# the soil moisture measures after 12:00 (or before 10:00) in the Excel sheet are = 0%, this experiment will only have 8 measures.


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[39]), ]
# last 2 rows of measures have soil moisture too low (0%), need to be removed.
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[39] & env_2022_clean$time_diff %in% c(105, 120)),]
# check the row was added correctly
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[39]), ]
# All other measures around exp time have 0% soil moisture, this experiment will have 7 measures


# load the climate measures for a given sample ID
env_2022[which(env_2022$Sample_ID == samples_0_22[40]), ]
# 1st row of measures has soil moisture too low (0%), needs to be removed
env_2022_clean <- env_2022_clean[-which(env_2022_clean$Sample_ID == samples_0_22[40] & env_2022_clean$time_diff == 3),]
# check modification was successful
env_2022_clean[which(env_2022_clean$Sample_ID == samples_0_22[40]), ]
# the soil moisture measures after 12:15 (or before 10:15) in the Excel sheet are = 0%, this experiment will only have 8 measures.
```

Notes on manual cleaning of samples:

* Sample 22-11008: all soil moisture values on exp day = 0%, logger was not used that way. Looking at data sheet, it does not seem like the logger number was mistyped (94233323). All values were changed to NA

* Sample 22-11019: all soil moisture values on exp day = 0%, logger was not used that way. Looking at data sheet, it does not seem like the logger number was mistyped (94233375). All values were changed to NA

* Sample 22-11032: all soil moisture values are very low, <1%.

* Sample 22-11036: all soil moisture values are very low, <1%.

* Sample 22-11043: climate logger 94233324 has all soil moisture values on day of experiment = 0%, climate logger was not used that day. In 2022, it was used for around 2 hours on 19.05 at 13:00 and on 20.05 at 12:00, then for two days between 20.05 and 22.05 for the pitfall trap experiment. Looking at the data sheet, it could be that the climate logger number was mistyped and that it is actually 94233329. I do not have data extracted for that logger, I will have to extract it.

* Sample 22-11046: all soil moisture values are very low, <1%. 1st 2 rows and last row of measures have soil moisture = 0%, they were removed. Rows 3 & 4 also have a volumetric soil moisture value of 0%, but the raw value is much higher than the other 0% values (650 vs. 420), so I have kept them for now.

* Sample 22-11082: 1st value is much lower than the rest. start of experiment at 12:40. Soil moisture values > 0% between 12:45 and 14:00, then 0% between 14:15 and 15:00, then 2 measures with >0% at 15:15 and 15:30. Not sure if they should be added. For now, simply copied below but not added to the dataset:  
  + 94226815	20/05/2022 15:15	20.875	23.1875	24.125	755	2.3  
  + 94226815	20/05/2022 15:30	22.1875	22.1875	23.5625	687	0.7


Now that the 2022 climate logger data has been manually checked and cleaned, we can plot the soil moisture again and see if the soil moisture values stay relatively constant throughout the experiment times. 

```{r 4.3.6 quality check clean data 2022}
# plot moisture over the 120 minutes of the experiment in chunks of 15 experiments

# Define the number of rows per plot and the total number of rows
rows_per_plot <- 135
total_rows <- nrow(env_2022_clean)

# Calculate the number of plots needed
num_plots <- ceiling(total_rows / rows_per_plot)

# Loop through each chunk
for (i in seq_len(num_plots)) {
  # Define the row range for this chunk
  start_row <- (i - 1) * rows_per_plot + 1
  end_row <- min(i * rows_per_plot, total_rows)  # Ensure not to exceed total rows
  
  # Extract the chunk of data
  data_chunk <- env_2022_clean[start_row:end_row, ]
  
  # Create the plot for this chunk
  plot <- ggplot(data_chunk, aes(
      x = as.numeric(time_diff),
      y = as.numeric(Vol_soil_moisture),
      group = as.factor(Sample_ID),
      color = as.factor(Sample_ID)
    )) +
    geom_smooth(se = F) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 12),
      legend.position = "right"
    ) +
    labs(
      x = "Time since experiment start",
      y = "Volumetric soil moisture [%]",
      color = "Sample ID",
      title = paste("Soil Moisture: Rows", start_row, "to", end_row)
    )
  
  # Print the plot to the console (for interactive use)
  print(plot)
  
  # Optionally save each plot to a file
  ggsave(
    filename = paste0("../images/logger_cleaning/2022_clean_moisture_over_time_plot_", i, ".png"),
    plot = plot,
    width = 8, height = 6
  )
}
```


There is still some variation (see specific remarks in the sections above) but the data looks much more even. Now that my 2022 climate data is cleaned, I will save the cleaned data in a .csv file then extract mean, minimum and maximum values per experiment for each climate measure and save that data into a new .csv file.

```{r 4.3.7 saving 2022 climate data}
# save complete 2022 cleaned data to a csv file
write.csv(env_2022_clean, "../data/env_data_loggers/env_data_2022_clean.csv", row.names = FALSE)

## Extracting mean, min, max values per experiment

# ensure logger measures are treated as numeric objects
env_2022_clean$T1 <- as.numeric(env_2022_clean$T1)
env_2022_clean$T2 <- as.numeric(env_2022_clean$T2)
env_2022_clean$T3 <- as.numeric(env_2022_clean$T3)
env_2022_clean$Raw_soil_moisture <- as.numeric(env_2022_clean$Raw_soil_moisture)
env_2022_clean$Vol_soil_moisture <- as.numeric(env_2022_clean$Vol_soil_moisture)

# calculate mean, min and max of climate logger data

env_data_2022_means <- data.frame()

for (i in unique(env_2022_clean$Sample_ID)) {
  sample_measures <- subset(env_2022_clean, env_2022_clean$Sample_ID  == i)
  
  T1_mean <-mean(sample_measures$T1)
  T1_max <-max(sample_measures$T1)
  T1_min <-min(sample_measures$T1)
  T1_sd <-sd(sample_measures$T1, na.rm = T)
  T1_var <-var(sample_measures$T1, na.rm = T)
  
  T2_mean <-mean(sample_measures$T2)
  T2_max <-max(sample_measures$T2)
  T2_min <-min(sample_measures$T2)
  T2_sd <-sd(sample_measures$T2, na.rm = T)
  T2_var <-var(sample_measures$T2, na.rm = T)
  
  T3_mean <-mean(sample_measures$T3)
  T3_max <-max(sample_measures$T3)
  T3_min <-min(sample_measures$T3)
  T3_sd <-sd(sample_measures$T3, na.rm = T)
  T3_var <-var(sample_measures$T3, na.rm = T)
  
  Raw_moist_mean <-mean(sample_measures$Raw_soil_moisture)
  Raw_moist_max <-max(sample_measures$Raw_soil_moisture)
  Raw_moist_min<-min(sample_measures$Raw_soil_moisture)
  Raw_moist_sd <-sd(sample_measures$Raw_soil_moisture, na.rm = T)
  Raw_moist_var <-var(sample_measures$Raw_soil_moisture, na.rm = T)
  
  Vol_moist_mean <-mean(sample_measures$Vol_soil_moisture)
  Vol_moist_max <-max(sample_measures$Vol_soil_moisture)
  Vol_moist_min <-min(sample_measures$Vol_soil_moisture)
  Vol_moist_sd <-sd(sample_measures$Vol_soil_moisture, na.rm = T)
  Vol_moist_var <-var(sample_measures$Vol_soil_moisture, na.rm = T)
  
  df <- cbind(i, T1_mean, T1_max, T1_min, T1_sd, T1_var, T2_mean, T2_max, T2_min, T2_sd, T2_var, T3_mean, T3_max, T3_min, T3_sd, T3_var, Raw_moist_mean, Raw_moist_max, Raw_moist_min, Raw_moist_sd, Raw_moist_var, Vol_moist_mean, Vol_moist_max, Vol_moist_min, Vol_moist_sd, Vol_moist_var)
  env_data_2022_means <- rbind(env_data_2022_means, df)
}

# create .csv file with calculated means for 2022 data
write.csv(env_data_2022_means, "../data/env_data_loggers/env_data_2022_means.csv", row.names = FALSE) 
```





